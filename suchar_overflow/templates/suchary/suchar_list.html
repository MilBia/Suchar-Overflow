{% extends "base.html" %}

{% load static %}

{% block title %}
  Suchary
{% endblock title %}
{% block content %}
  <div class="container py-4">
    <div class="row align-items-center mb-5 gy-4">
      <div class="col-lg-4">
        <h1 class="fw-bold text-primary mb-0">Suchary</h1>
        <p class="text-muted mb-0">Najsuchsze żarty w internecie.</p>
      </div>
      <div class="col-lg-8">
        <form method="get"
              class="d-flex align-items-center gap-2 justify-content-lg-end search-toolbar">
          {% for key, value in request.GET.items %}
            {% if key != 'q' and key != 'sort' %}<input type="hidden" name="{{ key }}" value="{{ value }}" />{% endif %}
          {% endfor %}

          <!-- Search Input Group with attached button -->
          <div class="input-group flex-nowrap align-items-stretch search-input-group">
            <input type="text"
                   name="q"
                   class="form-control mb-0 rounded-end-0"
                   style="border-right: 0"
                   placeholder="Szukaj..."
                   aria-label="Search"
                   value="{{ request.GET.q|default:'' }}" />
            <button class="btn btn-secondary border-start-0 ps-2 rounded-start-0 d-flex align-items-center"
                    type="submit">{% include "svgs/icon-search.svg" %}</button>
          </div>

          <!-- Custom Sort Dropdown -->
          <div class="custom-dropdown" id="sortDropdown">
            <input type="hidden"
                   name="sort"
                   value="{{ request.GET.sort|default:'newest' }}" />
            <button type="button" class="dropdown-trigger">
              <span class="selected-label">
                {% if request.GET.sort == 'top' %}
                  Najlepsze
                {% else %}
                  Najnowsze
                {% endif %}
              </span>
              <span class="chevron-icon">{% include "svgs/icon-chevron-down.svg" %}</span>
            </button>
            <div class="dropdown-menu">
              <div class="dropdown-item {% if not request.GET.sort or request.GET.sort == 'newest' %}selected{% endif %}"
                   data-value="newest">
                <span>Najnowsze</span>
                <span class="check-icon">{% include "svgs/icon-check.svg" %}</span>
              </div>
              <div class="dropdown-item {% if request.GET.sort == 'top' %}selected{% endif %}"
                   data-value="top">
                <span>Najlepsze</span>
                <span class="check-icon">{% include "svgs/icon-check.svg" %}</span>
              </div>
            </div>
          </div>

          <!-- Add Button -->
          <a href="{% url 'suchary:add' %}"
             class="btn btn-primary d-flex align-items-center text-nowrap">
            {% include "svgs/icon-plus.svg" %}
            Dodaj
          </a>
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-8">
        {% for suchar in suchary %}
          <div class="card suchar-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm flex-shrink-0 me-3">{% include "svgs/icon-user.svg" %}</div>
                  <div>
                    <h6 class="mb-0 fw-bold">{{ suchar.author.display_name }}</h6>
                    <small class="suchar-meta">{{ suchar.created_at|date:"d M Y, H:i" }}</small>
                  </div>
                </div>
              </div>
              <p class="mb-4">{{ suchar.text|linebreaksbr }}</p>
              {% if suchar.tags.all %}
                <div class="mb-3">
                  {% for tag in suchar.tags.all %}
                    <a href="?tag={{ tag.slug }}"
                       class="badge text-secondary border me-1 text-decoration-none bg-light">#{{ tag.name }}</a>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="d-flex align-items-center justify-content-between border-top pt-3">
                <div class="d-flex align-items-center">
                  <span class="vote-score me-3 d-flex align-items-center gap-2 text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="20"
                         height="20"
                         fill="currentColor"
                         class="text-warning"
                         viewBox="0 0 16 16">
                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z" />
                    </svg>
                    {{ suchar.score|default_if_none:0 }}
                  </span>
                </div>
                {% if user.is_authenticated %}
                  <div class="d-flex align-items-center gap-1">
                    <!-- Hidden CSRF Token for JS to grab -->
                    {% csrf_token %}
                    <button type="button"
                            data-suchar-id="{{ suchar.pk }}"
                            data-value="1"
                            class="btn btn-icon btn-vote {% if suchar.user_vote == 1 %}active{% endif %}"
                            title="Śmieszne (Głosuj w górę)">{% include "svgs/icon-vote-up.svg" %}</button>
                    <button type="button"
                            data-suchar-id="{{ suchar.pk }}"
                            data-value="-1"
                            class="btn btn-icon btn-vote {% if suchar.user_vote == -1 %}active{% endif %}"
                            title="Suchar (Głosuj w dół)">{% include "svgs/icon-vote-down.svg" %}</button>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-center py-5">
            <div class="mb-3 text-muted">{% include "svgs/icon-cracker-stack.svg" %}</div>
            <h3>Ale tu sucho...</h3>
            <p class="text-muted">Bądź bohaterem, którego potrzebujemy i dodaj pierwszego suchara.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% if is_paginated %}
    <div class="row mt-4">
      <div class="col-12">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}">Poprzednia</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Poprzednia</span>
              </li>
            {% endif %}
            {% for i in paginator.page_range %}
              {% if page_obj.number == i %}
                <li class="page-item active">
                  <span class="page-link">{{ i }}</span>
                </li>
              {% else %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}">
                    {{ i }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}">Następna</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Następna</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  {% endif %}
{% endblock content %}

{% block javascript %}
  {{ block.super }}
  <script defer src="{% static 'js/features/voting.js' %}"></script>
{% endblock javascript %}
