{% extends "base.html" %}

{% load static i18n %}

{% block title %}
  {% trans "Leaderboard" %}
{% endblock title %}

{% block content %}
  <div class="container py-5">
    <div class="text-center mb-5">
      <h1 class="display-4 fw-bold text-primary">{% trans "Leaderboard" %}</h1>
      <p class="lead text-muted">{% trans "Celebreating the best (and the driest) caused by our community." %}</p>
    </div>

    <!-- Global Activity Chart -->
    <div class="card shadow-sm border-0 mb-5">
      <div class="card-body p-4">
        <h5 class="fw-bold mb-4">{% trans "Activity (Last 30 Days)" %}</h5>
        <div class="chart-container-lg">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-pills mb-4" id="leaderboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active rounded-pill fw-bold"
                id="overall-tab"
                data-bs-toggle="tab"
                data-bs-target="#overall"
                type="button"
                role="tab"
                aria-controls="overall"
                aria-selected="true">üèÜ {% trans "Overall" %}</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill fw-bold"
                id="funny-tab"
                data-bs-toggle="tab"
                data-bs-target="#funny"
                type="button"
                role="tab"
                aria-controls="funny"
                aria-selected="false">ü§£ {% trans "Funny" %}</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill fw-bold"
                id="dry-tab"
                data-bs-toggle="tab"
                data-bs-target="#dry"
                type="button"
                role="tab"
                aria-controls="dry"
                aria-selected="false">üåµ {% trans "Dry" %}</button>
      </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="leaderboardTabsContent">

      <!-- 1. Overall Tab -->
      <div class="tab-pane fade show active"
           id="overall"
           role="tabpanel"
           aria-labelledby="overall-tab">
        <div class="row g-5">
          <!-- Top Authors -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-gold py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper header-icon-user">{% include "svgs/icon-user.svg" %}</div>
                  <h4 class="mb-0 fw-bold">{% trans "Most Active Authors" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for author in top_authors_overall %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex align-items-center mb-2">
                      <span class="h2 fw-bold text-muted me-3 mb-0 rank-col rank-{{ forloop.counter }}">#{{ forloop.counter }}</span>
                      <div class="flex-grow-1">
                        <h5 class="mb-0 fw-bold">
                          <a href="{% url 'users:detail' author.username %}"
                             class="text-decoration-none text-dark">{{ author.display_name }}</a>
                        </h5>
                        <small class="text-muted">{{ author.suchar_count }} {% trans "jokes" %}</small>
                      </div>
                      <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 fw-bold mb-1">{{ author.total_score }} {% trans "Votes" %}</span>
                        <small class="text-muted stats-text-sm">
                          <span class="text-warning-emphasis fw-bold">{{ author.funny_score }} F</span> / <span class="text-info fw-bold">{{ author.dry_score }} D</span>
                        </small>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No data." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
          <!-- Top Suchars -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-gold py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper header-icon-cracker">{% include "svgs/icon-cracker-stack.svg" %}</div>
                  <h4 class="mb-0 fw-bold">{% trans "Hall of Fame" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for suchar in top_suchars_overall %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1 text-muted small">
                        <span class="fw-bold text-dark rank-{{ forloop.counter }}">#{{ forloop.counter }}</span> by {{ suchar.author.display_name }}
                      </h6>
                      <small class="text-muted">{{ suchar.created_at|date:"d M" }}</small>
                    </div>
                    <p class="mb-2 fst-italic">"{{ suchar.text|truncatechars:100 }}"</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-light text-secondary border">#{{ suchar.tags.first.name|default:"general" }}</span>
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success bg-opacity-10 text-success border border-success">{{ suchar.score }} {% trans "Votes" %}</span>
                        <span class="badge bg-warning text-dark">{{ suchar.funny_count }} F</span>
                        <span class="badge bg-info text-white">{{ suchar.dry_count }} D</span>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No jokes." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Funny Tab (Standardized) -->
      <div class="tab-pane fade"
           id="funny"
           role="tabpanel"
           aria-labelledby="funny-tab">
        <div class="row g-5">
          <!-- Comedy Kings (Authors) -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-funny py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper text-white header-icon-emoji">ü§£</div>
                  <h4 class="mb-0 fw-bold text-white">{% trans "Comedy Kings" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for author in top_authors_funny %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex align-items-center mb-2">
                      <span class="h2 fw-bold text-muted me-3 mb-0 rank-col rank-{{ forloop.counter }}">#{{ forloop.counter }}</span>
                      <div class="flex-grow-1">
                        <h5 class="mb-0 fw-bold">
                          <a href="{% url 'users:detail' author.username %}"
                             class="text-decoration-none text-dark">{{ author.display_name }}</a>
                        </h5>
                        <small class="text-muted">{{ author.suchar_count }} {% trans "jokes" %}</small>
                      </div>
                      <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-warning text-dark border border-warning border-opacity-25 fw-bold mb-1">{{ author.funny_score }} {% trans "Funny" %}</span>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No funny data." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
          <!-- Top Funny Jokes (Suchars) -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-funny py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper text-white header-icon-emoji">üé≠</div>
                  <h4 class="mb-0 fw-bold text-white">{% trans "Top Funny Jokes" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for suchar in top_suchars_funny %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1 text-muted small">
                        <span class="fw-bold text-dark rank-{{ forloop.counter }}">#{{ forloop.counter }}</span> by {{ suchar.author.display_name }}
                      </h6>
                      <small class="text-muted">{{ suchar.created_at|date:"d M" }}</small>
                    </div>
                    <p class="mb-2 fst-italic">"{{ suchar.text|truncatechars:100 }}"</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-light text-secondary border">#{{ suchar.tags.first.name|default:"general" }}</span>
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-warning text-dark">{{ suchar.funny_count }} F</span>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No jokes." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Dry Tab (Standardized) -->
      <div class="tab-pane fade"
           id="dry"
           role="tabpanel"
           aria-labelledby="dry-tab">
        <div class="row g-5">
          <!-- Lords of Drought (Authors) -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-dry py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper text-white header-icon-emoji">üåµ</div>
                  <h4 class="mb-0 fw-bold text-white">{% trans "Lords of Drought" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for author in top_authors_dry %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex align-items-center mb-2">
                      <span class="h2 fw-bold text-muted me-3 mb-0 rank-col rank-{{ forloop.counter }}">#{{ forloop.counter }}</span>
                      <div class="flex-grow-1">
                        <h5 class="mb-0 fw-bold">
                          <a href="{% url 'users:detail' author.username %}"
                             class="text-decoration-none text-dark">{{ author.display_name }}</a>
                        </h5>
                        <small class="text-muted">{{ author.suchar_count }} {% trans "jokes" %}</small>
                      </div>
                      <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-info text-white border border-info border-opacity-25 fw-bold mb-1">{{ author.dry_score }} {% trans "Dry" %}</span>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No dry data." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
          <!-- Top Dry Jokes (Suchars) -->
          <div class="col-lg-6">
            <div class="card shadow-lg border-0 h-100">
              <div class="card-header card-header-dry py-3 border-0">
                <div class="d-flex align-items-center gap-2">
                  <div class="header-icon-wrapper text-white header-icon-emoji">üíß</div>
                  <h4 class="mb-0 fw-bold text-white">{% trans "Top Dry Jokes" %}</h4>
                </div>
              </div>
              <div class="list-group list-group-flush">
                {% for suchar in top_suchars_dry %}
                  <div class="list-group-item p-3 border-0 border-bottom">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1 text-muted small">
                        <span class="fw-bold text-dark rank-{{ forloop.counter }}">#{{ forloop.counter }}</span> by {{ suchar.author.display_name }}
                      </h6>
                      <small class="text-muted">{{ suchar.created_at|date:"d M" }}</small>
                    </div>
                    <p class="mb-2 fst-italic">"{{ suchar.text|truncatechars:100 }}"</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-light text-secondary border">#{{ suchar.tags.first.name|default:"general" }}</span>
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-info text-white">{{ suchar.dry_count }} D</span>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="p-4 text-center text-muted">{% trans "No jokes." %}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- End Tab Content -->
  </div>
  <!-- End Container -->
{% endblock content %}

{% block javascript %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      const labels = JSON.parse('{{ chart_labels|safe }}');
      const data = JSON.parse('{{ chart_values|safe }}');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '{% trans "New Jokes" %}',
            data: data,
            borderColor: '#3b82f6', // Primary Blue
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              },
              grid: {
                borderDash: [2, 4]
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    });
  </script>
{% endblock javascript %}
