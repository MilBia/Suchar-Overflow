{% load static i18n %}

<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">

  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}
        Suchar Overflow
      {% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
          content="{% block description %}Agregator żartów o krytycznie niskim poziomie wilgotności.{% endblock description %}" />
    <meta name="author" content="Miłosz Białczak" />

    <!-- Open Graph -->
    <meta property="og:title"
          content="{% block og_title %}Suchar Overflow{% endblock og_title %}" />
    <meta property="og:description"
          content="{% block og_description %}Agregator żartów o krytycznie niskim poziomie wilgotności.{% endblock og_description %}" />
    <meta property="og:image"
          content="{% block og_image %}{% static 'images/favicons/favicon.ico' %}{% endblock og_image %}" />
    <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
          rel="stylesheet" />
    {% block css %}
      <link href="{% static 'css/base.css' %}" rel="stylesheet" />
      <link href="{% static 'css/project.css' %}" rel="stylesheet" />
    {% endblock css %}
    {% block javascript %}
      <script defer src="{% static 'js/project.js' %}"></script>
    {% endblock javascript %}
    <script>
      // Immediately invoke to prevent flash of wrong theme and icon
      (function() {
        const localTheme = localStorage.getItem('theme');
        const theme = localTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);

        // Pre-render the correct icon to avoid flicker
        // We will make the icon visible via CSS or JS once loaded, or set innerHTML here if we blocking render
        // Better strategy: Set a class on body or html that style the button icon?
        // Actually, we can just save the theme in a global variable and let the button use it immediately when parsing
        window.__initialTheme = theme;
      })();
    </script>
    <style>
      /* Hide the theme toggle button content until JS determines correct icon,
         OR use CSS based on data-theme to toggle visibility of two icons if present.
         Let's try the CSS approach for instant switch. */
      .theme-icon-sun,
      .theme-icon-moon {
        display: none;
      }

      [data-theme="dark"] .theme-icon-sun {
        display: inline-block;
      }

      [data-theme="light"] .theme-icon-moon {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container navbar-container">
        <a class="navbar-brand" href="{% url 'home' %}">
          <svg xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               fill="currentColor"
               class="logo-icon"
               viewBox="0 0 16 16">
            <path d="M8.5 2a5.001 5.001 0 0 1 4.905 4.027A3 3 0 0 1 13 12H3.5A3.5 3.5 0 0 1 .035 9H5.5a.5.5 0 0 0 0-1H.035a3.5 3.5 0 0 1 3.871-2.977A5.001 5.001 0 0 1 8.5 2m-6 8a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zM0 13.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5" />
          </svg>
          Suchar Overflow
        </a>

        <button class="navbar-toggler"
                id="navbar-toggler"
                aria-label="Toggle navigation">
          <span class="toggler-icon"></span>
          <span class="toggler-icon"></span>
          <span class="toggler-icon"></span>
        </button>

        <div class="navbar-menu" id="navbar-menu">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'suchary:list' %}">Suchary</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'about' %}">O projekcie</a>
            </li>
          </ul>
          <div class="navbar-actions">
            <button id="theme-toggle" class="btn btn-icon" aria-label="Toggle theme">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="20"
                   height="20"
                   fill="currentColor"
                   class="bi bi-moon-stars-fill theme-icon-moon"
                   viewBox="0 0 16 16">
                <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278" />
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="20"
                   height="20"
                   fill="currentColor"
                   class="bi bi-sun-fill theme-icon-sun"
                   viewBox="0 0 16 16">
                <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z" />
              </svg>
            </button>
            {% if request.user.is_authenticated %}
              <a class="nav-link user-link d-flex align-items-center gap-2"
                 href="{% url 'users:detail' request.user.username %}">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="20"
                     height="20"
                     fill="currentColor"
                     class="bi bi-person-circle me-1"
                     viewBox="0 0 16 16">
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                  <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                </svg>
                {{ request.user.username }}
              </a>
              <button class="btn btn-secondary btn-sm" id="logout-button">Wyloguj</button>
            {% else %}
              <a class="btn btn-outline btn-sm" href="{% url 'account_login' %}">Zaloguj</a>
              <a class="btn btn-primary btn-sm" href="{% url 'account_signup' %}">Rejestracja</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    <!-- Main Content -->
    <main class="main-wrapper">
      <div class="container mt-content">
        {% block content %}
          <p>Domyślna treść.</p>
        {% endblock content %}
      </div>
    </main>
    <!-- Footer -->
    <footer class="footer">
      <div class="container text-center">
        <p class="text-muted mb-0">
          © {% now "Y" %} Suchar Overflow.
          <span class="d-block d-sm-inline mt-1 mt-sm-0">Wszelkie prawa zastrzeżone (ale żarty ukradzione).</span>
        </p>
      </div>
    </footer>

    <!-- Toasts Container -->
    <div class="toast-container" id="toast-container">
      {% if messages %}
        {% for message in messages %}
          <div class="toast toast-{{ message.tags }}" role="alert">
            <div class="toast-header">
              <strong class="me-auto">
                {% if 'error' in message.tags %}
                  Błąd
                {% elif 'success' in message.tags %}
                  Sukces
                {% else %}
                  Powiadomienie
                {% endif %}
              </strong>
              <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="toast-body">{{ message }}</div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Logout Modal -->
    <div class="modal-overlay" id="logoutModal" hidden>
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
          <h5 class="modal-title">Potwierdzenie wylogowania</h5>
          <button type="button" class="btn-close modal-close" aria-label="Close"></button>
        </div>
        <div class="modal-body">Czy na pewno chcesz się wylogować?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary modal-close">Anuluj</button>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Wyloguj się</button>
          </form>
        </div>
      </div>
    </div>

    {% block modal %}
    {% endblock modal %}
    {% block inline_javascript %}
    {% endblock inline_javascript %}
  </body>

</html>
