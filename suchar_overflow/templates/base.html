{% load static i18n %}

<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">

  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}
        Suchar Overflow
      {% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
          content="{% block description %}Agregator żartów o krytycznie niskim poziomie wilgotności.{% endblock description %}" />
    <meta name="author" content="Miłosz Białczak" />

    <!-- Open Graph -->
    <meta property="og:title"
          content="{% block og_title %}Suchar Overflow{% endblock og_title %}" />
    <meta property="og:description"
          content="{% block og_description %}Agregator żartów o krytycznie niskim poziomie wilgotności.{% endblock og_description %}" />
    <meta property="og:image"
          content="{% block og_image %}{% static 'images/favicons/favicon.ico' %}{% endblock og_image %}" />
    <!-- "{% static 'images/logo.svg' %}" -->
    <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <link rel="icon" href="{% static 'images/favicons/favicon.svg' %}" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
          rel="stylesheet" />
    {% block css %}
      <link href="{% static 'css/base.css' %}" rel="stylesheet" />
      <link href="{% static 'css/project.css' %}" rel="stylesheet" />
    {% endblock css %}
    {% block javascript %}
      <script defer src="{% static 'js/project.js' %}"></script>
    {% endblock javascript %}
    <script>
      // Immediately invoke to prevent flash of wrong theme and icon
      (function() {
        const localTheme = localStorage.getItem('theme');
        const theme = localTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);

        // Pre-render the correct icon to avoid flicker
        // We will make the icon visible via CSS or JS once loaded, or set innerHTML here if we blocking render
        // Better strategy: Set a class on body or html that style the button icon?
        // Actually, we can just save the theme in a global variable and let the button use it immediately when parsing
        window.__initialTheme = theme;
      })();
    </script>
    <style>
      /* Hide the theme toggle button content until JS determines correct icon,
         OR use CSS based on data-theme to toggle visibility of two icons if present.
         Let's try the CSS approach for instant switch. */
      .theme-icon-sun,
      .theme-icon-moon {
        display: none;
      }

      [data-theme="dark"] .theme-icon-sun {
        display: inline-block;
      }

      [data-theme="light"] .theme-icon-moon {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container navbar-container">
        <a class="navbar-brand d-flex align-items-center gap-2"
           href="{% url 'home' %}">{% include "svgs/logo.svg" %}</a>

        <button class="navbar-toggler"
                id="navbar-toggler"
                aria-label="Toggle navigation">
          <span class="toggler-icon"></span>
          <span class="toggler-icon"></span>
          <span class="toggler-icon"></span>
        </button>

        <div class="navbar-menu" id="navbar-menu">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'suchary:list' %}">Suchary</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'about' %}">O projekcie</a>
            </li>
          </ul>
          <div class="navbar-actions">
            <button id="theme-toggle" class="btn btn-icon" aria-label="Toggle theme">
              {% include "svgs/icon-moon.svg" %}
              {% include "svgs/icon-sun.svg" %}
            </button>
            {% if request.user.is_authenticated %}
              <a class="nav-link user-link d-flex align-items-center gap-2"
                 href="{% url 'users:detail' request.user.username %}">
                {% include "svgs/icon-user.svg" %}
                {{ request.user.username }}
              </a>
              <button class="btn btn-secondary btn-sm" id="logout-button">Wyloguj</button>
            {% else %}
              <a class="btn btn-outline btn-sm" href="{% url 'account_login' %}">Zaloguj</a>
              <a class="btn btn-primary btn-sm" href="{% url 'account_signup' %}">Rejestracja</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    <!-- Main Content -->
    <main class="main-wrapper">
      <div class="container mt-content">
        {% block content %}
          <p>Domyślna treść.</p>
        {% endblock content %}
      </div>
    </main>
    <!-- Footer -->
    <footer class="footer">
      <div class="container text-center">
        <p class="text-muted mb-0">
          © {% now "Y" %} Suchar Overflow.
          <span class="d-block d-sm-inline mt-1 mt-sm-0">Wszelkie prawa zastrzeżone (ale żarty ukradzione).</span>
        </p>
      </div>
    </footer>

    <!-- Toasts Container -->
    <div class="toast-container" id="toast-container">
      {% if messages %}
        {% for message in messages %}
          <div class="toast toast-{{ message.tags }}" role="alert">
            <div class="toast-header">
              <strong class="me-auto">
                {% if 'error' in message.tags %}
                  Błąd
                {% elif 'success' in message.tags %}
                  Sukces
                {% else %}
                  Powiadomienie
                {% endif %}
              </strong>
              <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="toast-body">{{ message }}</div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Logout Modal -->
    <div class="modal-overlay" id="logoutModal" hidden>
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
          <h5 class="modal-title">Potwierdzenie wylogowania</h5>
          <button type="button" class="btn-close modal-close" aria-label="Close"></button>
        </div>
        <div class="modal-body">Czy na pewno chcesz się wylogować?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary modal-close">Anuluj</button>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Wyloguj się</button>
          </form>
        </div>
      </div>
    </div>

    {% block modal %}
    {% endblock modal %}
    {% block inline_javascript %}
    {% endblock inline_javascript %}
  </body>

</html>
